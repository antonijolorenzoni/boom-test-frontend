---
kind: pipeline
type: docker
name: compile-test-pipeline

platform:
  os: linux
  arch: amd64

steps:

  - name: restore-cache
    image: meltwater/drone-cache:dev
    settings:
      access_key: 
        from_secret: access_key
      secret_key: 
        from_secret: secret_key
      restore: true
      bucket: boom-drone-demo
      region: eu-west-1
      mount:
        - "/drone/src/node_modules"


  - name: compile-with-yarn
    image: node:12-alpine3.10
    commands:
      - ls -lrtas ./node_modules
      - yarn
      - yarn workspaces run test
      - ls -lrtas
    environment:
      CI: "true"
      REACT_APP_API_BASE_URL: http://localhost:8080
      REACT_APP_API_VERSION: v1

  - name: rebuild-cache
    image: meltwater/drone-cache:dev
    settings:
      access_key: 
        from_secret: access_key
      secret_key: 
        from_secret: secret_key
      rebuild: true
      bucket: boom-drone-demo
      region: eu-west-1
      mount:
        - "/drone/src/node_modules"
    when:
      status:
      - failure      
      - success


trigger:
  branch:
    - master
    - develop
  event:
    - push

