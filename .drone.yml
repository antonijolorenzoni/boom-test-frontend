---
kind: pipeline
type: docker
name: compile-test-pipeline

platform:
  os: linux
  arch: amd64

steps:

  - name: restore-cache
    image: meltwater/drone-cache:v1.1
    settings:
      access_key: AKIA2O2WA53GZBCSPNA5
      secret_key: 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
      restore: true
      bucket: boom-drone-demo
      region: eu-west-1
      mount:
        - "/drone/src/node_modules"


  - name: compile-with-yarn
    image: node:12-alpine3.10
    commands:
      - yarn
      #- yarn workspaces run test
      - ls -lrtas
    #env:
    #    CI: true
    #    REACT_APP_API_BASE_URL: http://localhost:8080
    #    REACT_APP_API_VERSION: v1

  - name: rebuild-cache
    image: meltwater/drone-cache:v1.1
    settings:
      access_key: AKIA2O2WA53GZBCSPNA5
      secret_key: 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
      rebuild: true
      bucket: boom-drone-demo
      region: eu-west-1
      mount:
        - "/drone/src/node_modules"
    when:
      status:
      - failure      
      - success


trigger:
  branch:
    - master
    - develop
  event:
    - push

